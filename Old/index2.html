<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/materialize.css">
    <link rel="stylesheet" href="css/materialize.min.css">
    <link rel="stylesheet" href="css/font-awesome.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/custom.css">
    <script src="https://www.gstatic.com/firebasejs/3.0.0/firebase.js"></script>
    <script src="js/jquery-3.2.0.min.js"></script>
    <script src="js/materialize.js"></script>
    <script src="js/materialize.min.js"></script>
    <script src="js/md5.js"></script>
<title>ChatBox</title>
<style>
    ul li h6{
        margin-left: 5px;
    }
    li{
    border-radius: 25px;
    border: 2px solid #73AD21;
    padding: 20px; 
    width: auto ;
    height: auto ; 
    }
  h6 { font-size: 1.2rem;}
  img { max-width: 200px;
        max-height: 120px;
        display: block;
        }
        
img:active {
    -webkit-transform: scale(2);
    transform: scale(2);
}
  @keyframes yellow-fade { 0% {background: #f2f2b8;} 100% {background: none;} }
  .highlight { -webkit-animation: yellow-fade 2s ease-in 1; animation: yellow-fade 2s ease-in 1; }
</style>
<script>
 $( document ).ready(function()  {
     $("img").addClass("materialboxed");
     $('.chatBox').hide();
     $('#msgNameBtn').click(function() { 
           
            var username=null;
            username=document.getElementById("msgName").value;
            password=document.getElementById("password").value;
            password=password.toLowerCase();
            var result = (MD5(password));
            //md5 keys
            if(result==compare){
                   console.log("psdskfa");
                   $('.chatBox').fadeIn(1000);
                   $('#loginBox').fadeOut(1000);

                    document.getElementById('username').innerText=username;
                    // Step 0: HTML defined, variables for elements
                    //dateObject
                    var dateObj = new Date(),
                    month = dateObj.getUTCMonth() + 1, //months from 1-12
                    day = dateObj.getUTCDate(),
                    year = dateObj.getUTCFullYear(),
                    hours =dateObj.getHours(),
                    minutes =dateObj.getMinutes();
                    if(hours<12){
                        minutes= minutes +" AM";
                        }
                    else{
                        hours=hours-12;
                        minutes=minutes+" PM";
                        }
                    var d = year + "/" + month + "/" + day +" "+ hours + ":" + minutes;
                    //work starts here
                    var messagesList = document.getElementById('messages'),
                        textInput = document.getElementById('text'),
                        setUsernameButton=document.getElementById('msgNameBtn'),
                        sendButton = document.getElementById('send'),
                        //usernameElm = document.getElementById('username'),
                        password = document.getElementById('password');
                    var config = {
                        apiKey: "AIzaSyADFRhiooTKcWzRjjOmn-0sURrtuJeReh8",
                        authDomain: "fir-chat-2a1fe.firebaseapp.com",
                        databaseURL: "https://fir-chat-2a1fe.firebaseio.com",
                        projectId: "fir-chat-2a1fe",
                        storageBucket: "fir-chat-2a1fe.appspot.com",
                        messagingSenderId: "668124991211"
                    };
                    var app = firebase.initializeApp(config),
                        database = app.database(),
                        auth = app.auth(),
                        storage = app.storage();
                        
                    var databaseRef = database.ref().child('chat');
                    sendButton.addEventListener('click', function(evt) {
                          //dateObject//gets instancc e time for eacg msg
                                    var dateObj = new Date(),
                                    month = dateObj.getUTCMonth() + 1, //months from 1-12
                                    day = dateObj.getUTCDate(),
                                    year = dateObj.getUTCFullYear(),
                                    hours =dateObj.getHours(),
                                    minutes =dateObj.getMinutes();
                                    if(hours<12){
                                        minutes= minutes +" AM";
                                        }
                                    else{
                                        hours=hours-12;
                                        minutes=minutes+" PM";
                                        }
                                    var d = year + "/" + month + "/" + day +" "+ hours + ":" + minutes;
                        var chat = { name: "From:: "+username, message: textInput.value+"\n"+d };
                        databaseRef.push().set(chat);
                        textInput.value = '';
                    });
                    
                    // Listen for when child nodes get added to the collection
                    databaseRef.on('child_added', function(snapshot) {
                        // Get the chat message from the snapshot and add it to the UI
                        var chat = snapshot.val();
                        addMessage(chat);
                    });

                    function handleFileSelect(e) {
                        var file = e.target.files[0];
                        // Get a reference to the location where we'll store our photos
                        var storageRef = storage.ref().child('chat_photos');
                        
                        // Get a reference to store file at photos/<FILENAME>.jpg
                        var photoRef = storageRef.child(file.name);
                        // Upload file to Firebase Storage
                        var uploadTask = photoRef.put(file);
                        uploadTask.on('state_changed', null, null, function() {
                        // When the image has successfully uploaded, we get its download URL
                        var downloadUrl = uploadTask.snapshot.downloadURL;
                        // Set the download URL to the message box, so that the user can send it to the database
                    //     textInput.value = downloadUrl;
                        // Set the download URL to the message box, so that the user can send it to the database
                                //textInput.value = downloadUrl;
                                    // Directly posting the picture in chat box
                                      //dateObject//gets instancc e time for eacg msg
                                    var dateObj = new Date(),
                                    month = dateObj.getUTCMonth() + 1, //months from 1-12
                                    day = dateObj.getUTCDate(),
                                    year = dateObj.getUTCFullYear(),
                                    hours =dateObj.getHours(),
                                    minutes =dateObj.getMinutes();
                                    if(hours<12){
                                        minutes= minutes +" AM";
                                        }
                                    else{
                                        hours=hours-12;
                                        minutes=minutes+" PM";
                                        }
                                    var d = year + "/" + month + "/" + day +" "+ hours + ":" + minutes;
                                    var chat = { name: "From: "+username +"\n"+ d, message: downloadUrl  };
                                    databaseRef.push().set(chat);
                                    textInput.value = '';
                        });
                    }
                    file.addEventListener('change', handleFileSelect, false);
                    function addMessage(chat) {
                        var li = document.createElement('li');
                        var nameElm = document.createElement('h6');
                        nameElm.innerText = chat.name;
                        li.appendChild(nameElm);
                        li.className = 'highlight';
                        if ( chat.message.indexOf("https://firebasestorage.googleapis.com/") == 0
                        || chat.message.indexOf("https://lh3.googleusercontent.com/") == 0
                        || chat.message.indexOf("http://pbs.twimg.com/") == 0
                        || chat.message.indexOf("data:image/") == 0) {
                        var imgElm = document.createElement('img');
                        imgElm.src = chat.message;
                        li.appendChild(imgElm);
                        }
                        else {
                        var messageElm = document.createElement("span");
                        messageElm.innerText = chat.message;
                        li.appendChild(messageElm);
                        }
                        messagesList.appendChild(li);
                        li.scrollIntoView(false);
                        sendButton.scrollIntoView(false);
                    }
                            
            
            }
            else{
                alert("Wrong Password");
                document.getElementById('password').value="";
            }                

            });//msgNameBtn id function ends here
  });//jquery script ends here
</script>
</head>
<body>
  <div class="row">
      <div class="col s12 m6 offset-m3 l4 offset-l4">
          <div id='loginBox' class=" hoverable valign card-panel" style="background:#f5f5f5;">
                    <form action="" method="post" class="container-fluid ">
                        <div class="section"></div>
                        <center>
                            <img src="chatbox.png" alt="logo" class="responsive-img circle">
                        </center>
                        <div class="section"></div>
                        <div class="row input-field ">
                            <i class="fa fa-user prefix"></i>
                            <input id="msgName" type="text" name="msgName" class="validate">
                            <label for="msgName">Name</label>
                        </div>
                        <div class="row input-field ">
                            <i class="fa fa-pencil prefix"></i>
                            <input type="password" name="password" id="password" class="validate">
                            <label for="password">Password</label>
                        </div>
                        
                        <div class="row center">
                            <input type="button" id="msgNameBtn" name="msgNameBtn" value="login" class="btn">
                        </div>
                    </form>
             </div>
      </div>
  </div>
  
 <center> 
    <div class="chatBox  blue lighten-4 container card-panel white row" id="chatBox" >
        <h5>ChatBox</h5>
        <div>
                <ul style="background:#f5f5f5;" id='messages' class="left-align collection"></ul>

        </div>
        <div id='footer' class="row card-panel" style="background:#f5f5f5;">
            <h6>Send Message Here</h6>
            <div class="row">
                <div class="input-field col s12 m8 l8">
                <textarea id='text' class="materialize-textarea"></textarea>
                <label for="text">Message</label>
                </div>
                <div class="col s12 m4 l4 center">
                <a class="waves-effect waves-light btn" style="float:down;" id='send'>Send</a>
                </div>
            </div>
            <h6>Upload Files/Pictues Here</h6>
            <div class="row center">
                    <div class="file-field input-field">
                    <div class="btn">
                        <span>Upload</span>
                        <input type="file" id="file" name="file">
                    </div>
                    <div class="file-path-wrapper">
                        <input class="file-path validate" type="text">
                    </div>
                    </div>
            </div>
            <div class="row">   
                <span class="center"><span id='username' class="username"></span>(LoggedIn as)</span>
            </div>

        </div>
  </div>
  </center>
</body>
</html>
